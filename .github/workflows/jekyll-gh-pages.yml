name: multi-metrics
on:
  schedule: [{ cron: "23 3 * * *" }]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      OWNERS: "ipsbruno ipsbruno3 ipsbrunoreserva"   # <- edite aqui
      GH_TOKEN: ${{ github.token }}                  # token do Actions
    steps:
      - uses: actions/checkout@v4

      - name: Deps
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: gh login (explícito)
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          gh auth status

      - name: Somar stars/forks (REST robusto + logs)
        shell: bash
        run: |
          set -euo pipefail
          total_stars=0
          total_forks=0

          # Função: paginação REST (inclui só repos do dono, type=owner)
          fetch_repos() {
            local owner="$1" page=1
            while :; do
              resp=$(gh api -H "Accept: application/vnd.github+json" \
                "/users/${owner}/repos?per_page=100&page=${page}&type=owner")
              count=$(echo "$resp" | jq 'length')
              [[ "$count" -eq 0 ]] && break
              echo "$resp" | jq -c '.[]'
              page=$((page+1))
            done
          }

          mkdir -p tmp
          : > tmp/repos.jsonl

          for o in $OWNERS; do
            echo "::group::OWNER $o"
            fetch_repos "$o" >> tmp/repos.jsonl
            echo "repos coletados para $o: $(grep -c . tmp/repos.jsonl || true)"
            echo "::endgroup::"
          done

          # Filtro: ignore forks (mude para .fork==true se quiser incluir forks)
          total_stars=$(jq -s '[.[] | select(.fork==false) | .stargazers_count] | add // 0' tmp/repos.jsonl)
          total_forks=$(jq -s '[.[] | select(.fork==false) | .forks_count]     | add // 0' tmp/repos.jsonl)

          echo "TOTAL_STARS=$total_stars"
          echo "TOTAL_FORKS=$total_forks"

          mkdir -p docs
          jq -n --arg msg "$total_stars" '{
            schemaVersion: 1, label: "stars (multi)", message: $msg, color: "blue"
          }' > docs/stars.json

          jq -n --arg msg "$total_forks" '{
            schemaVersion: 1, label: "forks (multi)", message: $msg, color: "informational"
          }' > docs/forks.json

      - name: Top language (agregado por bytes)
        shell: bash
        run: |
          set -euo pipefail
          declare -A bytes
          while IFS= read -r line; do
            repo_full=$(echo "$line" | jq -r '.full_name')
            is_fork=$(echo "$line" | jq -r '.fork')
            [[ "$is_fork" == "true" ]] && continue
            gh api "/repos/${repo_full}/languages" \
              | jq -r 'to_entries[] | "\(.key)\t\(.value)"' \
              | while IFS=$'\t' read -r lang val; do
                  bytes["$lang"]=$(( ${bytes["$lang"]:-0} + val ))
                done
          done < tmp/repos.jsonl

          top="None"; max=0
          for k in "${!bytes[@]}"; do
            v=${bytes[$k]}
            if (( v > max )); then max=$v; top=$k; fi
          done

          jq -n --arg msg "$top" '{
            schemaVersion: 1, label: "top lang (multi)", message: $msg, color: "success"
          }' > docs/toplang.json

      - name: Commit JSONs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*.json
          git commit -m "update metrics JSON" || echo "no changes"
          git push
